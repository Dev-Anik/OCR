<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR Scanner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/3.0.3/tesseract.min.js" integrity="sha512-H1fQK9Bq3J9b57b8AphvKXga+undvNxdulY+WmE6RSD4fELdrU76CRfDoIuOtEIBw2swteNSAlwPEfAsqwv/qQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 20px auto;
            padding: 0 15px;
        }
        #canvas {
            width: 100%;
            border: 2px solid #333;
            display: block;
            margin: 15px 0;
        }
        #scanBtn {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #scanBtn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #result {
            width: 100%;
            margin-top: 15px;
            padding: 10px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        #status {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>OCR Scanner</h1>
    <div id="ocr-wrap">
    <video id="ocr-video" autoplay muted playsinline style="display:none;"></video>
    <canvas id="ocr-canvas"></canvas>
    </div>
    <button id="scanBtn">Scan Text</button>
    <div id="result"></div>

<script>
    // ============================================
    // OCR FUNCTIONALITY
    // ============================================
    let ocrContainer, videoElem, canvasElem;
    let ocrWorker = null;
    let ocrStream = null;
    let isRecognizing = false;
    let scanIntervalId = null;
    let drawAnimationId = null;
    ocrContainer = document.getElementById('ocr-wrap');
        videoElem = document.getElementById('ocr-video');
        canvasElem = document.getElementById('ocr-canvas');
        startOCR();
    async function startOCR() {
        if (!videoElem || !canvasElem) {
            console.error("OCR elements not found");
            return;
        }

        const scanBtn = document.getElementById('scanBtn');
        if (scanBtn) {
            scanBtn.removeEventListener('click', runOCR);
            scanBtn.addEventListener('click', runOCR);
        }

        await initOCRWorker();
        await startOCRCamera();
    }

    async function initOCRWorker() {
        if (ocrWorker) return;
        
        const { createWorker } = Tesseract;
        ocrWorker = createWorker();
        
        try {
            await ocrWorker.load();
            await ocrWorker.loadLanguage('eng');
            await ocrWorker.initialize('eng');
            console.log("Tesseract worker ready");
        } catch (err) {
            console.error("OCR worker init failed:", err);
        }
    }

    async function startOCRCamera() {
        try {
            ocrStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: { ideal: "environment" } },
                audio: false
            });
            
            videoElem.srcObject = ocrStream;
            await videoElem.play();

            await new Promise(resolve => {
                if (videoElem.readyState >= 1 && videoElem.videoWidth) return resolve();
                videoElem.addEventListener('loadedmetadata', resolve, { once: true });
            });

            canvasElem.width = videoElem.videoWidth;
            canvasElem.height = videoElem.videoHeight;

            startDrawLoop();
            console.log("OCR camera started");
        } catch (err) {
            console.error("Camera error:", err);
            alert("Camera not available or permission denied");
        }
    }

    function startDrawLoop() {
        if (drawAnimationId) cancelAnimationFrame(drawAnimationId);
        
        const draw = () => {
            const ctx = canvasElem.getContext('2d');
            ctx.drawImage(videoElem, 0, 0, canvasElem.width, canvasElem.height);

            const box = getOCRBox();
            ctx.save();
            ctx.lineWidth = 2;
            ctx.strokeStyle = 'red';
            ctx.strokeRect(box.x, box.y, box.w, box.h);
            ctx.restore();

            drawAnimationId = requestAnimationFrame(draw);
        };
        
        draw();
    }

    function getOCRBox() {
        const w = canvasElem.width - 100;
        const h = 130;
        const x = 50;
        const y = 300;
        return { x, y, w, h };
    }

    async function runOCR() {
        if (isRecognizing || !ocrWorker) return;
        
        isRecognizing = true;
        const scanBtn = document.getElementById('scan-again-btn');
        if (scanBtn) scanBtn.disabled = true;

        const box = getOCRBox();
        const buf = document.createElement('canvas');
        buf.width = box.w;
        buf.height = box.h;
        
        const bctx = buf.getContext('2d');
        bctx.drawImage(canvasElem, box.x, box.y, box.w, box.h, 0, 0, box.w, box.h);

        try {
		const res = await ocrWorker.recognize(buf);
		    kensakuberResultField.value = res.data.text;
		}catch (err) {
            console.error("OCR error:", err);
            alert("OCR failed: " + err.message);
        }
    }
</script>

</body>
</html>
