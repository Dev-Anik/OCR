<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manual OCR Scan</title>
  <script src="https://unpkg.com/tesseract.js@v3.0.3/dist/tesseract.min.js"></script>
  <style>
    #video, #canvas {
       width: 100%;
      height: 200px;
    }
    #scanBtn {
      margin: 10px 0;
      padding: 10px 20px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h1>OCR Manual Scan 1</h1>
  <button id="scanBtn">Scan Text</button>
  <p id="result"></p>
  <div class="wrap" style="position:relative;">
  <video id="video" autoplay muted playsinline
         style="position:absolute; inset:0; opacity:0;"></video>
  <canvas id="canvas" style="position:relative; display:block;"></canvas>
</div>


  <script>
    const videoElem = document.getElementById('video');
    const canvasElem = document.getElementById('canvas');
    const buf = document.createElement('canvas'); // OCR buffer
    const progressElem = document.getElementById('progress');
    const resultElem = document.getElementById('result');
    const scanBtn = document.getElementById('scanBtn');

    let isRecognizing = false;

    // -----------------------------
    // 1️⃣ Initialize Tesseract worker
    // -----------------------------
    const { createWorker } = Tesseract;
    const worker = createWorker();

    async function initWorker() {
      await worker.load();
      await worker.loadLanguage('eng');
      await worker.initialize('eng');
      console.log("Tesseract worker ready");
    }

    // -----------------------------
    // 2️⃣ Start camera preview
    // -----------------------------
    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: "environment" } },
          audio: false
        });
        videoElem.srcObject = stream;
        await videoElem.play();

        // wait until video metadata is ready (width/height available)
        await new Promise(resolve => {
          if (videoElem.readyState >= 1 && videoElem.videoWidth) return resolve();
          videoElem.addEventListener('loadedmetadata', () => resolve(), { once: true });
        });

        canvasElem.width = videoElem.videoWidth;
        canvasElem.height = videoElem.videoHeight;

        drawLoop(); // start live video + rectangle loop

      } catch (err) {
        console.error("Camera error", err);
        resultElem.textContent = "Camera not available or permission denied.";
      }
    }

    // -----------------------------
    // 3️⃣ Draw live video + rectangle
    // -----------------------------
    function getBox() {
      // OCR rectangle area
      const w = canvasElem.width - 100;
      const h = 100;
      const x = 50;
      const y = (canvasElem.height - h) / 2;
      return { x, y, w, h };
    }

    function drawLoop() {
      const ctx = canvasElem.getContext('2d');
      ctx.drawImage(videoElem, 0, 0, canvasElem.width, canvasElem.height);

      // draw OCR rectangle
      const box = getBox();
      ctx.save();
      ctx.lineWidth = 2;
      ctx.strokeStyle = 'red';
      ctx.strokeRect(box.x, box.y, box.w, box.h);
      ctx.restore();

      requestAnimationFrame(drawLoop); // loop for live video
    }

    // -----------------------------
    // 4️⃣ OCR function (manual)
    // -----------------------------
    async function runOCR() {
      if (isRecognizing) return; // prevent multiple clicks
      isRecognizing = true;
      scanBtn.disabled = true;

      const box = getBox();
      buf.width = box.w;
      buf.height = box.h;
      const bctx = buf.getContext('2d');
      bctx.drawImage(canvasElem, box.x, box.y, box.w, box.h, 0, 0, box.w, box.h);

      try {
        const res = await worker.recognize(buf);
        resultElem.textContent = res.data.text.replace(/\s+$/, '');
      } catch (err) {
        console.error("OCR error", err);
      } finally {
        isRecognizing = false;
        scanBtn.disabled = false;
      }
    }

    scanBtn.addEventListener('click', runOCR);

    // -----------------------------
    // 5️⃣ Initialize everything
    // -----------------------------
    (async () => {
      await initWorker();
      await startCamera();
    })();
  </script>
</body>
</html>



